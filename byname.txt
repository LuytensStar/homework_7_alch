from sqlalchemy import func, create_engine,desc
from sqlalchemy.orm import sessionmaker, relationship
from main import Subject,Student,Group,Grade,Teacher


engine = create_engine('postgresql://postgres:boba1234@localhost/postgres')

Session = sessionmaker(bind=engine)

session = Session()

def select_1(session):
    avg_grade = func.round(func.avg(Grade.value), 2).label('average')
    return session.query(Student.name, avg_grade).\
        join(Grade).\
        group_by(Student.id).\
        order_by(desc(avg_grade)).\
        limit(5).all()

def select_2(session, subject_name):
    avg_grade = func.round(func.avg(Grade.value),2).label('average')
    return session.query(Student.name, avg_grade).\
        join(Grade).join(Subject).\
        filter(Subject.name == subject_name).\
        group_by(Student.name).\
        order_by(desc(avg_grade)).\
        first()

def select_3(session, subject_name):
    avg_grade = func.round(func.avg(Grade.value),2).label('average')
    return session.query(Group.name,avg_grade).\
        select_from(Student).\
        join(Group).\
        join(Grade).\
        join(Subject).\
        filter(Subject.name == subject_name).\
        group_by(Group.name).all()

def select_4(session):
    return session.query(func.round(func.avg(Grade.value),2)).scalar()

def select_5(session,teacher_name):
    return session.query(Subject.name).\
        join(Teacher).\
        filter(Teacher.name==teacher_name).all()

def select_6(session, group_name):
    return session.query(Student.name).\
        join(Group).\
        filter(Group.name == group_name).\
        group_by(Student.name).all()

def select_7(session,group_name,subject_name):
    return session.query(Student.name,Grade.value).\
        join(Grade).join(Group).join(Subject).\
        filter(Group.name == group_name, Subject.name == subject_name).\
        group_by(Student.name, Grade.value).all()

def select_8(session,teacher_name):
    return session.query(func.round(func.avg(Grade.value),2)).\
        join(Subject).join(Teacher).\
        filter(Teacher.name == teacher_name).scalar()

def select_9(session,student_name):
    return session.query(Subject.name).\
    join(Grade).join(Student).\
    filter(Student.name == student_name).\
    group_by(Subject.name).all()

def select_10(session,student_name,teacher_name):
    return session.query(Subject.name).\
        join(Teacher).join(Grade).join(Student).\
        filter(Student.name == student_name, Teacher.name == teacher_name).\
        group_by(Subject.name).all()

students = select_1(session)
# for student in students:
#     print(f"Студент: {student[0]}, Середній бал: {student[1]}")


# s4 = select_4(session)
# print(s4)

# s5 = select_5(session,'Kristine Marks')
# print(s5)

# s6 = select_6(session, 'drive')
# print(s6)

# s7 = select_7(session, 'drive','boy')
# print(s7)

# s8 = select_8(session,'Kristine Marks')
# print(s8)

# s9 = select_9(session,'Louis Bell')
# print(s9)

s10 = select_10(session, 'Lawrence Velasquez','Kristine Marks')
print(s10)